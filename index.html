<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>School Carpool — Same School (Pulang Bermalam & Cuti)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    .glass { background: rgba(255,255,255,0.06); backdrop-filter: blur(8px) saturate(120%); border: 1px solid rgba(255,255,255,0.08); }
    #map { height: 220px; border-radius: 0.5rem; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-700 text-slate-100 p-6">
  <div class="max-w-5xl mx-auto">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-semibold">School Carpool — Same School</h1>
      <div>
        <button id="btn-signin" class="px-4 py-2 rounded-md glass">Sign in with Google</button>
        <button id="btn-signout" class="px-3 py-2 rounded-md glass hidden">Sign out</button>
      </div>
    </header>

    <main class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <section class="md:col-span-1 glass p-4 rounded-lg">
        <h2 class="text-lg font-medium">Parent Profile</h2>
        <div id="profile-area" class="mt-3 space-y-2">
          <p class="text-sm text-slate-300">Please sign in to continue.</p>
        </div>
        <hr class="my-3 border-slate-600" />
        <h3 class="text-sm font-medium">Children</h3>
        <div id="children-list" class="mt-2 space-y-2"></div>
        <button id="btn-add-child" class="mt-3 w-full px-3 py-2 rounded-md glass hidden">Add Child</button>
      </section>

      <section class="md:col-span-2 glass p-4 rounded-lg">
        <div class="flex items-start justify-between">
          <h2 class="text-lg font-medium">Available Trips (School-only)</h2>
          <div class="space-x-2">
            <button id="btn-create-trip" class="px-3 py-2 rounded-md glass hidden">Create Trip</button>
            <label class="text-sm text-slate-300">Filter:</label>
            <select id="filter-trip-type" class="rounded-md bg-transparent px-2 py-1 border border-slate-700">
              <option value="">All</option>
              <option value="Pulang Bermalam">Pulang Bermalam</option>
              <option value="Cuti">Cuti</option>
            </select>
          </div>
        </div>
        <div id="trips-area" class="mt-4 space-y-3"></div>
      </section>
    </main>

    <footer class="mt-6 text-sm text-slate-400">Hosted: <a class="underline" href="https://arsenaltegar-jpg.github.io/school-carpool" target="_blank">Project GitHub Pages</a> • Uses Supabase Auth & Realtime</footer>
  </div>

  <div id="modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div class="bg-black/60 absolute inset-0" onclick="closeModal()"></div>
    <div class="relative w-full max-w-2xl p-6 glass rounded-lg z-10">
      <div id="modal-content"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = 'https://zjxkykvkxfrndlcirfjg.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_MsYFfGjoGA-rl8PCjF-58Q_kGkMvzuF';
    const SCHOOL_NAME = 'Sekolah Contoh — (fixed)';

    const sbClient = createClient(SUPABASE_URL, SUPABASE_KEY);

    const btnSignin = document.getElementById('btn-signin');
    const btnSignout = document.getElementById('btn-signout');
    let currentUser = null;

    function el(html){ const t=document.createElement('div'); t.innerHTML=html.trim(); return t.firstChild; }
    function openModal(html){ document.getElementById('modal-content').innerHTML=html; document.getElementById('modal').classList.remove('hidden'); document.getElementById('modal').classList.add('flex'); }
    function closeModal(){ document.getElementById('modal').classList.remove('flex'); document.getElementById('modal').classList.add('hidden'); }

    btnSignin.addEventListener('click', async ()=>{
      await sbClient.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: window.location.origin } });
    });

    btnSignout.addEventListener('click', async ()=>{
      await sbClient.auth.signOut(); location.reload();
    });

    sbClient.auth.onAuthStateChange((event, session) => {
      if (session && session.user) {
        currentUser=session.user; afterSignIn(session.user);
      } else { currentUser=null; renderSignedOut(); }
    });

    async function afterSignIn(user){
      btnSignin.classList.add('hidden'); btnSignout.classList.remove('hidden');
      const { data } = await sbClient.from('parents').select('*').eq('google_uid', user.id).single().maybeSingle();
      if(!data){
        const profile = { google_uid:user.id, name:user.user_metadata.full_name||user.email.split('@')[0], email:user.email, phone:'', address:'', role:'parent'};
        const insert = await sbClient.from('parents').insert(profile).select().single();
        openProfileForm(insert.data||profile,true);
      } else { openProfileForm(data,false); }
      document.getElementById('btn-add-child').classList.remove('hidden');
      document.getElementById('btn-create-trip').classList.remove('hidden');
      loadChildren(); loadTrips();
    }

    function renderSignedOut(){
      document.getElementById('profile-area').innerHTML='<p class="text-sm text-slate-300">Please sign in with Google to access the carpool system.</p>';
      btnSignin.classList.remove('hidden'); btnSignout.classList.add('hidden');
      document.getElementById('btn-add-child').classList.add('hidden');
      document.getElementById('btn-create-trip').classList.add('hidden');
      document.getElementById('children-list').innerHTML='';
      document.getElementById('trips-area').innerHTML='';
    }

    function openProfileForm(profile,isNew){
      const html=`<h3 class='text-lg font-medium'>Complete Parent Profile</h3>
      <div class='mt-3 space-y-2'>
      <input id='pf-name' class='w-full p-2 rounded bg-slate-800' value='${profile.name||''}' placeholder='Full name'/>
      <input id='pf-phone' class='w-full p-2 rounded bg-slate-800' value='${profile.phone||''}' placeholder='Phone (WhatsApp)'/>
      <input id='pf-address' class='w-full p-2 rounded bg-slate-800' value='${profile.address||''}' placeholder='Address'/>
      <div class='flex gap-2'><button id='pf-save' class='px-3 py-2 rounded glass'>Save</button><button id='pf-close' class='px-3 py-2 rounded glass'>Close</button></div></div>`;
      openModal(html);
      document.getElementById('pf-close').onclick=closeModal;
      document.getElementById('pf-save').onclick=async()=>{
        const name=document.getElementById('pf-name').value.trim();
        const phone=document.getElementById('pf-phone').value.trim();
        const address=document.getElementById('pf-address').value.trim();
        await sbClient.from('parents').update({name,phone,address}).eq('google_uid',currentUser.id);
        closeModal(); loadChildren();
      };
    }

    document.getElementById('btn-add-child').onclick=()=>{
      const html=`<h3 class='text-lg font-medium'>Add Child</h3>
      <div class='mt-3 space-y-2'><input id='ch-name' placeholder='Name' class='w-full p-2 rounded bg-slate-800'/>
      <select id='ch-gender' class='w-full p-2 rounded bg-slate-800'><option>Male</option><option>Female</option></select>
      <input id='ch-level' placeholder='Tingkatan (e.g. 1)' class='w-full p-2 rounded bg-slate-800'/>
      <div class='flex gap-2'><button id='ch-save' class='px-3 py-2 rounded glass'>Save</button><button id='ch-cancel' class='px-3 py-2 rounded glass'>Cancel</button></div></div>`;
      openModal(html);
      document.getElementById('ch-cancel').onclick=closeModal;
      document.getElementById('ch-save').onclick=async()=>{
        const name=document.getElementById('ch-name').value.trim();
        const gender=document.getElementById('ch-gender').value;
        const level=document.getElementById('ch-level').value.trim();
        const p=await sbClient.from('parents').select('*').eq('google_uid',currentUser.id).single();
        await sbClient.from('children').insert({parent_id:p.data.id,name,gender,form_level:level,school_name:SCHOOL_NAME});
        closeModal(); loadChildren();
      };
    };

    async function loadChildren(){
      if(!currentUser)return;
      const p=await sbClient.from('parents').select('*').eq('google_uid',currentUser.id).single();
      const children=await sbClient.from('children').select('*').eq('parent_id',p.data.id);
      const list=document.getElementById('children-list'); list.innerHTML='';
      (children.data||[]).forEach(c=>list.append(el(`<div class='p-2 rounded border border-slate-700'>${c.name} — ${c.gender} — T:${c.form_level}</div>`)));
    }

    document.getElementById('btn-create-trip').onclick=()=>{
      const html=`<h3 class='text-lg font-medium'>Create Trip (Driver)</h3>
      <div class='mt-3 space-y-2'><select id='t-type' class='w-full p-2 rounded bg-slate-800'><option>Pulang Bermalam</option><option>Cuti</option></select>
      <input id='t-date' type='date' class='w-full p-2 rounded bg-slate-800'/>
      <input id='t-time' type='time' class='w-full p-2 rounded bg-slate-800'/>
      <input id='t-seats' type='number' min='1' value='3' class='w-full p-2 rounded bg-slate-800'/>
      <input id='t-dest' class='w-full p-2 rounded bg-slate-800' placeholder='Destination'/>
      <input id='t-remarks' class='w-full p-2 rounded bg-slate-800' placeholder='Remarks'/>
      <div class='flex gap-2'><button id='t-save' class='px-3 py-2 rounded glass'>Create</button><button id='t-cancel' class='px-3 py-2 rounded glass'>Cancel</button></div></div>`;
      openModal(html);
      document.getElementById('t-cancel').onclick=closeModal;
      document.getElementById('t-save').onclick=async()=>{
        const type=document.getElementById('t-type').value;
        const date=document.getElementById('t-date').value;
        const time=document.getElementById('t-time').value;
        const seats=parseInt(document.getElementById('t-seats').value)||1;
        const dest=document.getElementById('t-dest').value.trim();
        const remarks=document.getElementById('t-remarks').value.trim();
        const p=await sbClient.from('parents').select('*').eq('google_uid',currentUser.id).single();
        await sbClient.from('trips').insert({driver_id:p.data.id,trip_type:type,origin:'Sekolah',destination:dest,date,time,available_seats:seats,remarks,status:'Active'});
        closeModal(); loadTrips();
      };
    };

    async function loadTrips(){
      const filter=document.getElementById('filter-trip-type').value;
      let q=sbClient.from('trips').select('*').eq('status','Active').order('date',{ascending:true});
      if(filter)q=q.eq('trip_type',filter);
      const res=await q;
      const trips=res.data||[];
      const area=document.getElementById('trips-area'); area.innerHTML='';
      for(const trip of trips){
        const driver=await sbClient.from('parents').select('*').eq('id',trip.driver_id).single();
        const node=el(`<div class='p-3 rounded border border-slate-700 grid md:grid-cols-3 gap-2'>
          <div><div class='font-semibold'>${trip.trip_type} — ${trip.date} ${trip.time}</div><div class='text-sm text-slate-300'>To: ${trip.destination}</div></div>
          <div class='text-center'><div>Seats: ${trip.available_seats}</div><div>Driver: ${driver.data?.name||''}</div><div>${driver.data?.phone||''}</div></div>
          <div class='flex justify-end items-center gap-2'><button class='btn-book px-3 py-1 rounded glass' data-id='${trip.id}'>Book</button>
          <button class='btn-whatsapp px-3 py-1 rounded glass' data-phone='${driver.data?.phone||''}' data-name='${driver.data?.name||''}' data-trip='${trip.trip_type}' data-date='${trip.date}'>WhatsApp</button></div></div>`);

        node.querySelector('.btn-whatsapp').onclick=(e)=>{
          const btn=e.currentTarget; const phone=btn.dataset.phone; const driverName=btn.dataset.name; const tripType=btn.dataset.trip; const tripDate=btn.dataset.date;
          if(!phone)return alert('Driver phone not provided');
          const msg=`Hi ${driverName}, I'm interested in your ${tripType} trip on ${tripDate}.`;
          window.open(`https://wa.me/${phone.replace(/[^0-9]/g,'')}?text=${encodeURIComponent(msg)}`,'_blank');
        };

        node.querySelector('.btn-book').onclick=async(e)=>{
          if(!currentUser)return alert('Sign in first');
          const tripId=e.currentTarget.dataset.id;
          const p=await sbClient.from('parents').select('*').eq('google_uid',currentUser.id).single();
          const children=await sbClient.from('children').select('*').eq('parent_id',p.data.id);
          const childOptions=(children.data||[]).map(c=>`<option value='${c.id}'>${c.name} (${c.form_level})</option>`).join('');
          const html=`<h3 class='text-lg'>Select child</h3><select id='book-child' class='w-full p-2 rounded bg-slate-800 mt-3'>${childOptions}</select>
          <div class='flex gap-2 mt-3'><button id='book-confirm' class='px-3 py-2 rounded glass'>Confirm</button><button id='book-cancel' class='px-3 py-2 rounded glass'>Cancel</button></div>`;
          openModal(html);
          document.getElementById('book-cancel').onclick=closeModal;
          document.getElementById('book-confirm').onclick=async()=>{
            const childId=document.getElementById('book-child').value;
            const trip=await sbClient.from('trips').select('*').eq('id',tripId).single();
            await sbClient.from('trip_passengers').insert({trip_id:tripId,child_id:childId,booked_by_parent_id:p.data.id,status:'Confirmed'});
            await sbClient.from('trips').update({available_seats:trip.data.available_seats-1}).eq('id',tripId);
            closeModal(); loadTrips();
            const driver=await sbClient.from('parents').select
